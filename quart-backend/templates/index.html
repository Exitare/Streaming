<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AnoBrain Streams</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dark-glassy.css') }}"/>
</head>

<body>
<nav class="navbar navbar-expand-lg navbar-glassy fixed-top">
    <div class="container-fluid px-4">
        <a class="navbar-brand" href="#">
            <i class="fa-solid fa-tower-broadcast"></i> AnoBrain Streams
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarNav" aria-controls="navbarNav"
                aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon text-white"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
            <ul class="navbar-nav align-items-center">
                <li class="nav-item">
                    <a class="nav-link" href="#">Dashboard</a>
                </li>
                <!-- Add more links here -->
                <li class="nav-item">
                    <a class="nav-link" href="/signin">Sign In</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/signup">Sign Up</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<h1 class="text-center mb-4">
    <i class="fa-solid fa-tower-broadcast me-2 text-primary"></i>Live Streams
</h1>

<div class="stream-container" id="stream-container"></div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
    async function fetchStreams() {
        try {
            const response = await fetch("/streams");
            const streamKeys = await response.json();
            const container = document.getElementById("stream-container");

            container.innerHTML = ""; // clear any previous content

            if (streamKeys.length === 0) {
                container.innerHTML = `
                <div class="glass-card">
                    <h2><i class="fa-solid fa-circle-xmark text-secondary me-2"></i>No active streams found</h2>
                    <p class="status-indicator">Start streaming to see it appear here.</p>
                </div>
                `;
                return;
            }

            streamKeys.forEach(key => {
                const card = document.createElement("div");
                card.className = "glass-card";

                card.innerHTML = `
                    <h2><i class="fa-solid fa-circle-play text-success me-2"></i>Stream: <code>${key}</code></h2>
                    <video id="video-${key}" controls autoplay muted playsinline width="100%"></video>
                    <div class="status-indicator" id="status-${key}">Loading...</div>
                `;

                container.appendChild(card);

                const video = document.getElementById(`video-${key}`);
                const status = document.getElementById(`status-${key}`);
                const streamUrl = `${location.protocol}//${location.hostname}/hls/${key}.m3u8`;

                if (Hls.isSupported()) {
                    const hls = new Hls();
                    hls.loadSource(streamUrl);
                    hls.attachMedia(video);
                    hls.on(Hls.Events.MANIFEST_PARSED, () => {
                        video.play();
                        status.textContent = "üî¥ Live stream loaded";
                    });
                    hls.on(Hls.Events.ERROR, () => {
                        status.textContent = "‚ö†Ô∏è Error loading stream";
                    });
                } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
                    video.src = streamUrl;
                    video.addEventListener("loadedmetadata", () => {
                        video.play();
                        status.textContent = "üî¥ Live stream loaded (native)";
                    });
                } else {
                    status.textContent = "‚ùå HLS not supported";
                }
            });
        } catch (err) {
            document.getElementById("stream-container").innerHTML =
                "<p class='text-danger'>Failed to load streams.</p>";
            console.error("Stream loading error:", err);
        }
    }

    fetchStreams();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>