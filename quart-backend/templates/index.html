{% extends "base.html" %}
{% block title %}Live Streams{% endblock %}

{% block content %}
<h1 class="text-center mb-4">
    <i class="fa-solid fa-tower-broadcast me-2 text-primary"></i>Live Streams
</h1>

<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="stream-container" id="stream-container"></div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
    async function fetchStreams() {
        try {
            const response = await fetch("/streams");
            const streamKeys = await response.json();
            const container = document.getElementById("stream-container");

            container.innerHTML = ""; // clear any previous content

            if (streamKeys.length === 0) {
                container.innerHTML = `
                <div class="glass-card">
                    <h2><i class="fa-solid fa-circle-xmark text-secondary me-2"></i>No active streams found</h2>
                    <p class="status-indicator">They will be back shortly.</p>
                </div>
                `;
                return;
            }

            streamKeys.forEach(key => {
                const card = document.createElement("div");
                card.className = "glass-card";

                card.innerHTML = `
                    <h2><i class="fa-solid fa-circle-play text-success me-2"></i>Stream: <code>${key}</code></h2>
                    <video id="video-${key}" controls autoplay muted playsinline></video>
                    <div class="status-indicator" id="status-${key}">Loading...</div>
                `;

                container.appendChild(card);

                const video = document.getElementById(`video-${key}`);
                const status = document.getElementById(`status-${key}`);
                const streamUrl = `${location.protocol}//${location.hostname}/hls/${key}.m3u8`;

                if (Hls.isSupported()) {
                    const hls = new Hls();
                    hls.loadSource(streamUrl);
                    hls.attachMedia(video);
                    hls.on(Hls.Events.MANIFEST_PARSED, () => {
                        video.play();
                        status.textContent = "üü¢ Live stream loaded";
                    });
                    hls.on(Hls.Events.ERROR, () => {
                        status.textContent = "‚ö†Ô∏è Error loading stream";
                    });
                } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
                    video.src = streamUrl;
                    video.addEventListener("loadedmetadata", () => {
                        video.play();
                        status.textContent = "üü¢ Live stream loaded (native)";
                    });
                } else {
                    status.textContent = "‚ùå HLS not supported";
                }
            });
        } catch (err) {
            document.getElementById("stream-container").innerHTML =
                "<p class='text-danger'>Failed to load streams.</p>";
            console.error("Stream loading error:", err);
        }
    }

    fetchStreams();
</script>
{% endblock %}